
> healthtech-triage@1.0.0 test
> jest tests/integration/PatientManagementRoutes.spec.ts --silent

npm : FAIL tests/integration/PatientManagementRoutes.spec.ts
En línea: 1 Carácter: 1
+ npm test -- tests/integration/PatientManagementRoutes.spec.ts 
--silen ...
+ 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/inte...tRout 
   es.spec.ts:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Patient Management Routes Integration Tests (TDD)
    Authentication & Authorization
      ÔêÜ debe rechazar request sin token JWT (401) (56 ms)
      ÔêÜ debe permitir acceso con token v├ílido de DOCTOR (200) (9 
ms)
    PATCH /api/v1/patients/:id/assign-doctor
      ├ù debe asignar doctor a paciente exitosamente (200) (7 ms)
      ÔêÜ debe rechazar si falta doctorId (400) (6 ms)
      ÔêÜ debe retornar 400 si paciente no existe (7 ms)
      ÔêÜ debe retornar 400 si doctor no existe (8 ms)
      ├ù debe manejar errores del repositorio (500) (6 ms)
    POST /api/v1/patients/:id/comments
      ├ù debe agregar comentario exitosamente (201) (3 ms)
      ÔêÜ debe rechazar si faltan campos requeridos (400) (6 ms)
      ├ù debe rechazar type inv├ílido (400) (7 ms)
      ├ù debe manejar errores del repositorio (500) (6 ms)
    PATCH /api/v1/patients/:id/status
      ÔêÜ debe actualizar status exitosamente (200) (6 ms)
      ÔêÜ debe rechazar si falta status (400) (5 ms)
      ÔêÜ debe rechazar status inv├ílido (400) (4 ms)
      ÔêÜ debe aceptar todos los status v├ílidos (200) (20 ms)
      ├ù debe manejar errores del repositorio (500) (5 ms)
    PATCH /api/v1/patients/:id/priority
      ÔêÜ debe establecer prioridad manual exitosamente (200) (6 ms)
      ÔêÜ debe aceptar prioridades v├ílidas 1-5 (18 ms)
      ÔêÜ debe rechazar si falta priority (400) (6 ms)
      ├ù debe rechazar prioridad fuera del rango 1-5 (400) (5 ms)
      ÔêÜ debe rechazar prioridad no num├®rica (400) (4 ms)
      ÔêÜ debe retornar 404 si paciente no existe (5 ms)
      ÔêÜ debe manejar errores del repositorio (500) (4 ms)
    GET /api/v1/patients/assigned/:doctorId
      ├ù debe retornar pacientes asignados al doctor (200) (6 ms)
      ├ù debe retornar lista vac├¡a si doctor no tiene pacientes 
(200) (4 ms)
      ├ù debe manejar errores del repositorio (500) (5 ms)
    GET /api/v1/patients/:id/comments
      ├ù debe retornar comentarios del paciente (200) (1 ms)
      ÔêÜ debe retornar lista vac├¡a si no hay comentarios (200) (4 
ms)
      ÔêÜ debe retornar 404 si paciente no existe (4 ms)
      ÔêÜ debe manejar errores del repositorio (500) (4 ms)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ PATCH 
/api/v1/patients/:id/assign-doctor ÔÇ║ debe asignar doctor a 
paciente exitosamente (200)

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 190 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
     [90m 191 |[39m         [33m.[39msend({ doctorId[33m:[39m 
mockDoctor[33m.[39mid[33m.[39mvalue })
    [31m[1m>[22m[39m[90m 192 |[39m         
[33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 193 |[39m
     [90m 194 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 195 |[39m       expect(response[33m.[39mbody[33m.[39m
message)[33m.[39mtoContain([32m'asignado'[39m)[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:192:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ PATCH 
/api/v1/patients/:id/assign-doctor ÔÇ║ debe manejar errores del 
repositorio (500)

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 240 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
     [90m 241 |[39m         [33m.[39msend({ doctorId[33m:[39m 
mockDoctor[33m.[39mid[33m.[39mvalue })
    [31m[1m>[22m[39m[90m 242 |[39m         
[33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 243 |[39m
     [90m 244 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 245 |[39m     })[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:242:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ POST 
/api/v1/patients/:id/comments ÔÇ║ debe agregar comentario 
exitosamente (201)

    Author ID is required

    [0m [90m 76 |[39m
     [90m 77 |[39m     [36mif[39m 
([33m![39m[36mthis[39m[33m.[39mprops[33m.[39mauthorId 
[33m||[39m 
[36mthis[39m[33m.[39mprops[33m.[39mauthorId[33m.[39mtrim() 
[33m===[39m [32m''[39m) {
    [31m[1m>[22m[39m[90m 78 |[39m       [36mthrow[39m 
[36mnew[39m [33mError[39m([32m'Author ID is 
required'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 79 |[39m     }
     [90m 80 |[39m
     [90m 81 |[39m     [36mif[39m 
([33m![39m[36mthis[39m[33m.[39mprops[33m.[39mcontent 
[33m||[39m [36mthis[39m[33m.[39mprops[33m.[39mcontent[33m.[
39mtrim()[33m.[39mlength [33m<[39m [35m5[39m) {[0m

      at PatientComment.validate 
(src/domain/entities/PatientComment.ts:78:13)
      at new validate (src/domain/entities/PatientComment.ts:41:10)
      at Function.create 
(src/domain/entities/PatientComment.ts:50:12)
      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:257:42)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ POST 
/api/v1/patients/:id/comments ÔÇ║ debe rechazar type inv├ílido (400)

    expect(received).toContain(expected) // indexOf

    Expected substring: "Type inv├ílido"
    Received string:    "authorId, content y type son requeridos"

    [0m [90m 306 |[39m
     [90m 307 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 308 |[39m       expect(response[33m.
[39mbody[33m.[39merror)[33m.[39mtoContain([32m'Type 
inv├ílido'[39m)[33m;[39m
     [90m     |[39m                                   
[31m[1m^[22m[39m
     [90m 309 |[39m     })[33m;[39m
     [90m 310 |[39m
     [90m 311 |[39m     it([32m'debe manejar errores del 
repositorio (500)'[39m[33m,[39m [36masync[39m () [33m=>[39m 
{[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:308:35)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ POST 
/api/v1/patients/:id/comments ÔÇ║ debe manejar errores del 
repositorio (500)

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 320 |[39m           type[33m:[39m 
[32m'observation'[39m[33m,[39m
     [90m 321 |[39m         })
    [31m[1m>[22m[39m[90m 322 |[39m         
[33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 323 |[39m
     [90m 324 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 325 |[39m     })[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:322:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ PATCH 
/api/v1/patients/:id/status ÔÇ║ debe manejar errores del repositorio 
(500)

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 401 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
     [90m 402 |[39m         [33m.[39msend({ status[33m:[39m 
[32m'waiting'[39m })
    [31m[1m>[22m[39m[90m 403 |[39m         
[33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 404 |[39m
     [90m 405 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 406 |[39m     })[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:403:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ PATCH 
/api/v1/patients/:id/priority ÔÇ║ debe rechazar prioridad fuera del 
rango 1-5 (400)

    expect(received).toContain(expected) // indexOf

    Expected substring: "entre 1 y 5"
    Received string:    "priority es requerido"

    [0m [90m 463 |[39m
     [90m 464 |[39m         expect(response[33m.[39mstatus)[33m.
[39mtoBe([35m400[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 465 |[39m         expect(response[33m
.[39mbody[33m.[39merror)[33m.[39mtoContain([32m'entre 1 y 
5'[39m)[33m;[39m
     [90m     |[39m                                     
[31m[1m^[22m[39m
     [90m 466 |[39m       }
     [90m 467 |[39m     })[33m;[39m
     [90m 468 |[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:465:37)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ GET 
/api/v1/patients/assigned/:doctorId ÔÇ║ debe retornar pacientes 
asignados al doctor (200)

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 516 |[39m         [33m.[39m[36mget[39m([32m`/api
/v1/patients/assigned/${mockDoctor.id.value}`[39m)
     [90m 517 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
    [31m[1m>[22m[39m[90m 518 |[39m         
[33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 519 |[39m
     [90m 520 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 521 |[39m       expect(response[33m.[39mbody[33m.[39m
count)[33m.[39mtoBeGreaterThanOrEqual([35m0[39m)[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:518:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ GET 
/api/v1/patients/assigned/:doctorId ÔÇ║ debe retornar lista vac├¡a 
si doctor no tiene pacientes (200)

    expected 200 "OK", got 400 "Bad Request"

    [0m [90m 529 |[39m         [33m.[39m[36mget[39m([32m`/api
/v1/patients/assigned/${mockDoctor.id.value}`[39m)
     [90m 530 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
    [31m[1m>[22m[39m[90m 531 |[39m         
[33m.[39mexpect([35m200[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 532 |[39m
     [90m 533 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 534 |[39m       expect(response[33m.[39mbody[33m.[39m
count)[33m.[39mtoBe([35m0[39m)[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:531:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ GET 
/api/v1/patients/assigned/:doctorId ÔÇ║ debe manejar errores del 
repositorio (500)

    expected 500 "Internal Server Error", got 400 "Bad Request"

    [0m [90m 541 |[39m         [33m.[39m[36mget[39m([32m`/api
/v1/patients/assigned/${mockDoctor.id.value}`[39m)
     [90m 542 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${doctorToken}`[39m)
    [31m[1m>[22m[39m[90m 543 |[39m         
[33m.[39mexpect([35m500[39m)[33m;[39m
     [90m     |[39m          [31m[1m^[22m[39m
     [90m 544 |[39m
     [90m 545 |[39m       expect(response[33m.[39mbody[33m.[39m
success)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 546 |[39m     })[33m;[39m[0m

      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:543:10)
      ----
      at Test._assertStatus 
(node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction 
(node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> 
(node_modules/supertest/lib/test.js:152:11)

  ÔùÅ Patient Management Routes Integration Tests (TDD) ÔÇ║ GET 
/api/v1/patients/:id/comments ÔÇ║ debe retornar comentarios del 
paciente (200)

    Author ID is required

    [0m [90m 76 |[39m
     [90m 77 |[39m     [36mif[39m 
([33m![39m[36mthis[39m[33m.[39mprops[33m.[39mauthorId 
[33m||[39m 
[36mthis[39m[33m.[39mprops[33m.[39mauthorId[33m.[39mtrim() 
[33m===[39m [32m''[39m) {
    [31m[1m>[22m[39m[90m 78 |[39m       [36mthrow[39m 
[36mnew[39m [33mError[39m([32m'Author ID is 
required'[39m)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 79 |[39m     }
     [90m 80 |[39m
     [90m 81 |[39m     [36mif[39m 
([33m![39m[36mthis[39m[33m.[39mprops[33m.[39mcontent 
[33m||[39m [36mthis[39m[33m.[39mprops[33m.[39mcontent[33m.[
39mtrim()[33m.[39mlength [33m<[39m [35m5[39m) {[0m

      at PatientComment.validate 
(src/domain/entities/PatientComment.ts:78:13)
      at new validate (src/domain/entities/PatientComment.ts:41:10)
      at Function.create 
(src/domain/entities/PatientComment.ts:50:12)
      at Object.<anonymous> 
(tests/integration/PatientManagementRoutes.spec.ts:556:24)

----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------
File                              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                      
----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------
All files                         |   15.63 |    12.23 |   16.32 |    15.7 |                                                                        
 src                              |       0 |        0 |       0 |       0 |                                                                        
  app.ts                          |       0 |      100 |       0 |       0 | 16-54                                                                  
  server.ts                       |       0 |        0 |       0 |       0 | 14-132                                                                 
 src/application                  |       0 |        0 |       0 |       0 |                                                                        
  AuditService.ts                 |       0 |        0 |       0 |       0 | 1-283                                                                  
  NotificationService.ts          |       0 |        0 |       0 |       0 | 1-200                                                                  
  PatientService.ts               |       0 |        0 |       0 |       0 | 12-192                                                                 
  VitalsService.ts                |       0 |        0 |       0 |       0 | 1-292                                                                  
 src/application/observers        |       0 |        0 |       0 |       0 |                                                                        
  AuditObserver.ts                |       0 |        0 |       0 |       0 | 14-78                                                                  
  DoctorNotificationObserver.ts   |       0 |        0 |       0 |       0 | 20-199                                                                 
 src/application/services         |   48.61 |    20.58 |    62.5 |   48.61 |                                                                        
  AuthService.ts                  |   48.61 |    20.58 |    62.5 |   48.61 | 100,107,115,127,144,152,181,194,206,213,228-334                        
 src/application/use-cases        |   17.58 |      4.5 |      24 |   17.58 |                                                                        
  AddCommentToPatientUseCase.ts   |    7.14 |        0 |       0 |    7.14 | 37-114                                                                 
  AssignDoctorToPatientUseCase.ts |      50 |    33.33 |     100 |      50 | 44,53,61,77-99                                                         
  CreateUserUseCase.ts            |       0 |        0 |       0 |       0 | 10-188                                                                 
  GetDoctorPatientsUseCase.ts     |      75 |       25 |     100 |      75 | 33,42,51                                                               
  RegisterPatientUseCase.ts       |       0 |        0 |       0 |       0 | 23-313                                                                 
  UpdatePatientStatusUseCase.ts   |   81.25 |       20 |     100 |   81.25 | 38,45,54                                                               
 src/domain                       |       0 |        0 |       0 |       0 |                                                                        
  TriageEngine.ts                 |       0 |        0 |       0 |       0 | 85-303                                                                 
 src/domain/entities              |      40 |     47.7 |      29 |      40 |                                                                        
  Doctor.ts                       |   47.16 |    45.83 |      25 |   47.16 | 81-93,101,105,109,113-197                                              
  Nurse.ts                        |       0 |        0 |       0 |       0 | 8-152                                                                  
  Patient.ts                      |   45.16 |     57.5 |   31.42 |   45.16 | 93,101,105,109,113,117,130,134,138,142,152-224,239-256,264,284,295-329 
  PatientComment.ts               |   39.02 |    44.44 |   22.22 |   39.02 | 62,70,74,81-161                                                        
  User.ts                         |   58.97 |    66.66 |   52.63 |   58.97 | 65,73,77,81,85,107-115,126-152                                         
 src/domain/errors                |       0 |        0 |       0 |       0 |                                                                        
  NotificationErrors.ts           |       0 |        0 |       0 |       0 | 14-62                                                                  
  PatientErrors.ts                |       0 |        0 |       0 |       0 | 15-81                                                                  
  TriageErrors.ts                 |       0 |        0 |       0 |       0 | 14-58                                                                  
  VitalsErrors.ts                 |       0 |        0 |       0 |       0 | 14-94                                                                  
 src/domain/observers             |       0 |      100 |       0 |       0 |                                                                        
  TriageEvents.ts                 |       0 |      100 |       0 |       0 | 148-217                                                                
 src/shared                       |       0 |        0 |       0 |       0 |                                                                        
  Logger.ts                       |       0 |        0 |       0 |       0 | 13-173                                                                 
  Result.ts                       |       0 |        0 |       0 |       0 | 29-219                                                                 
  validators.ts                   |       0 |        0 |       0 |       0 | 11-112                                                                 
----------------------------------|---------|----------|---------|---------|------------------------------------------------------------------------
Jest: "./src/app.ts" coverage threshold for statements (80%) not 
met: 0%
Jest: "./src/app.ts" coverage threshold for lines (80%) not met: 0%
Jest: "./src/app.ts" coverage threshold for functions (80%) not met: 
0%
Test Suites: 1 failed, 1 total
Tests:       11 failed, 19 passed, 30 total
Snapshots:   0 total
Time:        3.261 s
