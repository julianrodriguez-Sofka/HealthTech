# ====================================================================
# PR Check - Required Status Check
# ====================================================================
# Workflow m√≠nimo que debe pasar para aprobar PRs
# Configura este workflow como "required" en Branch Protection Rules
# ====================================================================

name: PR Check

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.19.5'

jobs:
  pr-validation:
    name: üîê PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint Check
        run: npm run lint

      - name: Build Check
        run: npm run build

      - name: Run Tests
        run: npm run test:coverage

      - name: Check Coverage Threshold
        run: |
          # Extract coverage percentage from lcov.info
          if [ -f coverage/lcov.info ]; then
            LINES_FOUND=$(grep -oP 'LF:\K\d+' coverage/lcov.info | awk '{s+=$1} END {print s}')
            LINES_HIT=$(grep -oP 'LH:\K\d+' coverage/lcov.info | awk '{s+=$1} END {print s}')
            
            if [ "$LINES_FOUND" -gt 0 ]; then
              COVERAGE=$(echo "scale=2; $LINES_HIT * 100 / $LINES_FOUND" | bc)
              echo "üìä Coverage: ${COVERAGE}%"
              
              # Threshold check (warning only, not blocking)
              if (( $(echo "$COVERAGE < 50" | bc -l) )); then
                echo "‚ö†Ô∏è Warning: Coverage is below 50%"
              else
                echo "‚úÖ Coverage threshold met"
              fi
            fi
          fi

      - name: PR Ready
        run: echo "‚úÖ PR validation passed - ready for review"
