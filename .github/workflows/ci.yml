# ====================================================================
# CI Quality Gate - GitHub Actions Workflow
# ====================================================================
# Este workflow implementa un Quality Gate automatizado que se ejecuta
# en cada push o pull request para garantizar la calidad del código
# antes de permitir merges a las ramas principales (main/develop).
# ====================================================================

name: CI Quality Gate

# ====================================================================
# TRIGGERS: Define cuándo se ejecuta el workflow
# ====================================================================
# Se ejecuta en:
# - Cada push a main o develop
# - Cada pull request que tenga como destino main o develop
# Esto garantiza que todo código que intente llegar a producción
# pase por las validaciones de calidad.
# ====================================================================
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# ====================================================================
# JOBS: Define las tareas a ejecutar
# ====================================================================
jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      # ================================================================
      # PASO 1: Checkout del código fuente
      # ================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch completo del historial para análisis de SonarCloud
          fetch-depth: 0

      # ================================================================
      # PASO 2: Setup de Node.js v20.19.5
      # ================================================================
      # ¿Por qué Node.js 20.19.5?
      # - Versión LTS (Long Term Support) con soporte hasta abril 2026
      # - Incluye mejoras de performance y seguridad
      # - Compatibilidad estable con TypeScript 5.x
      # - Garantiza reproducibilidad entre entornos (dev, CI, prod)
      # - Evita "works on my machine" por diferencias de versión
      # ================================================================
      - name: Setup Node.js 20.19.5
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5'
          # Cachea node_modules para acelerar builds subsecuentes
          cache: 'npm'

      # ================================================================
      # PASO 3: Instalación de dependencias
      # ================================================================
      # Usamos 'npm ci' en lugar de 'npm install' porque:
      # - Instala exactamente las versiones del package-lock.json
      # - Es más rápido (10-20% faster)
      # - Elimina node_modules antes de instalar (instalación limpia)
      # - Falla si package.json y package-lock.json están desincronizados
      # - Ideal para CI/CD donde necesitamos reproducibilidad
      # ================================================================
      - name: Install dependencies
        run: npm ci

      # ================================================================
      # PASO 4: Linting - Validación de Clean Code
      # ================================================================
      # Ejecuta ESLint para verificar:
      # - Estándares de código (naming conventions, formatting)
      # - Detección de code smells y anti-patterns
      # - Cumplimiento de reglas de TypeScript
      # - Garantiza legibilidad y mantenibilidad
      # Si falla, el workflow se detiene y no permite el merge
      # ================================================================
      - name: Run linter
        run: npm run lint

      # ================================================================
      # PASO 5: Build - Compilación de TypeScript
      # ================================================================
      # Ejecuta el compilador de TypeScript (tsc) para:
      # - Verificar que no hay errores de tipado
      # - Validar que el código compila correctamente
      # - Detectar errores de tipos antes de runtime
      # - Generar los archivos JavaScript transpilados
      # Si hay errores de tipos, el build falla y detiene el workflow
      # ================================================================
      - name: Build TypeScript
        run: npm run build

      # ================================================================
      # PASO 6: Tests Unitarios + Cobertura
      # ================================================================
      # Ejecuta Jest con coverage para:
      # - Correr todos los tests unitarios
      # - Generar reporte de cobertura en formato LCOV
      # - LCOV es un formato estándar que SonarCloud puede leer
      # 
      # El reporte LCOV generalmente se guarda en:
      # ./coverage/lcov.info
      # 
      # Este archivo contiene información detallada de qué líneas,
      # funciones y branches fueron ejecutados durante los tests.
      # ================================================================
      - name: Run tests with coverage
        run: npm run test:coverage

      # ================================================================
      # PASO 7: SonarCloud - Análisis de Calidad
      # ================================================================
      # ¿Cómo se conecta el reporte de cobertura con SonarCloud?
      # 
      # 1. Jest genera coverage/lcov.info durante el paso anterior
      # 2. SonarCloud lee este archivo automáticamente si está en
      #    la ubicación estándar o se especifica en sonar-project.properties
      # 3. SonarCloud analiza:
      #    - Cobertura de código (líneas, branches, funciones)
      #    - Code smells y vulnerabilidades
      #    - Duplicación de código
      #    - Complejidad ciclomática
      # 4. Aplica el Quality Gate (mínimo 70% de cobertura)
      # 5. Si no cumple, falla el workflow y bloquea el merge
      # 
      # Secretos requeridos:
      # - SONAR_TOKEN: Token de autenticación de SonarCloud
      # - GITHUB_TOKEN: Provisto automáticamente por GitHub
      # ================================================================
      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        env:
          # Token de SonarCloud (configurar en GitHub Secrets)
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          # Token de GitHub (automático, para comentar en PRs)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Argumentos adicionales para SonarScanner
          args: >
            -Dsonar.projectKey=julianrodriguez-Sofka_HealthTech
            -Dsonar.organization=julianrodriguez-sofka
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.ts,**/*.spec.ts,**/tests/**
            -Dsonar.qualitygate.wait=true

# ====================================================================
# CONFIGURACIÓN REQUERIDA EN SONARCLOUD
# ====================================================================
# 1. Crear proyecto en SonarCloud vinculado a este repositorio
# 2. Configurar Quality Gate con:
#    - Coverage mínimo: 70%
#    - Reliability Rating: A
#    - Security Rating: A
#    - Maintainability Rating: A
# 3. Generar SONAR_TOKEN y agregarlo a GitHub Secrets
# 4. El workflow fallará si no se cumplen estas métricas
# ====================================================================
